# Webアラームサービス 基本設計書（簡易版・音声なし）

## 1. システム概要

### 1.1 サービス概要
ユーザーが自由に複数のアラームを設定し、設定時刻になると通知を行うシンプルなWebサービス。音声機能を省略し、最小限の機能で実装しやすい構成。

### 1.2 主要機能
- 複数アラームの設定・管理
- ブラウザ通知（プッシュ通知・ポップアップ）
- シンプルなWebUI
- ユーザー認証

### 1.3 システムアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │    │   バックエンド    │    │   データベース   │
│   (React/Vue.js)  │◄──►│   (FastAPI)     │◄──►│ (Cloud SQL PG)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │
         │                        │
         ▼                        ▼
┌─────────────────┐    ┌─────────────────┐
│ Browser Push API │    │   Cloud Run     │
│   (通知機能)      │    │  (ホスティング)   │
└─────────────────┘    └─────────────────┘
```

## 2. データ設計

### 2.1 Cloud SQL (PostgreSQL) 構造

#### 2.1.1 usersテーブル
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    timezone VARCHAR(50) DEFAULT 'Asia/Tokyo',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.2 alarmsテーブル
```sql
CREATE TABLE alarms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    year INTEGER NULL,
    month INTEGER NULL,
    day_of_week INTEGER[] NULL, -- 0=日曜日, 1=月曜日, ...
    hour INTEGER NOT NULL CHECK (hour >= 0 AND hour <= 23),
    minute INTEGER NOT NULL CHECK (minute >= 0 AND minute <= 59),
    is_active BOOLEAN DEFAULT TRUE,
    notification_type VARCHAR(20) DEFAULT 'popup', -- 'popup', 'push', 'both'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.3 notification_logsテーブル
```sql
CREATE TABLE notification_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    alarm_id UUID REFERENCES alarms(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    notification_type VARCHAR(20) NOT NULL,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL -- 'sent', 'delivered', 'failed'
);
```

### 2.2 データフロー
1. ユーザーがアラームを設定
2. バックエンドがアラームデータをCloud SQLに保存
3. Cloud Scheduler（定期実行）がアラームをチェック
4. 発動時刻に通知を送信
5. 通知ログを記録

## 3. API設計

### 3.1 認証API
- `POST /api/auth/register` - ユーザー登録
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - ユーザー情報取得

### 3.2 アラーム管理API
- `GET /api/alarms` - アラーム一覧取得
- `POST /api/alarms` - アラーム作成
- `PUT /api/alarms/{id}` - アラーム更新
- `DELETE /api/alarms/{id}` - アラーム削除
- `PATCH /api/alarms/{id}/toggle` - アラーム有効/無効切り替え

### 3.3 通知API
- `POST /api/notifications/subscribe` - プッシュ通知登録
- `DELETE /api/notifications/unsubscribe` - プッシュ通知解除
- `GET /api/notifications/logs` - 通知履歴取得

### 3.4 APIレスポンス例

#### アラーム作成リクエスト
```json
{
  "title": "朝のアラーム",
  "description": "毎朝7時30分",
  "year": null,
  "month": null,
  "day_of_week": [1, 2, 3, 4, 5],
  "hour": 7,
  "minute": 30,
  "notification_type": "both"
}
```

#### アラーム一覧レスポンス
```json
{
  "alarms": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "title": "朝のアラーム",
      "description": "毎朝7時30分",
      "year": null,
      "month": null,
      "day_of_week": [1, 2, 3, 4, 5],
      "hour": 7,
      "minute": 30,
      "is_active": true,
      "notification_type": "both",
      "created_at": "2025-01-11T00:00:00Z",
      "updated_at": "2025-01-11T00:00:00Z"
    }
  ],
  "total": 1
}
```

## 4. フロントエンド設計

### 4.1 画面構成
- **ログイン画面** - 認証（シンプルなフォーム）
- **アラーム一覧画面** - 設定済みアラームの表示・管理
- **アラーム設定画面** - 新規作成・編集フォーム
- **設定画面** - 通知設定・タイムゾーン設定

### 4.2 コンポーネント設計

#### 4.2.1 主要コンポーネント
- `AlarmList` - アラーム一覧表示
- `AlarmForm` - アラーム設定フォーム
- `NotificationSettings` - 通知設定
- `AlarmCard` - 個別アラーム表示カード

#### 4.2.2 状態管理（シンプル版）
```javascript
// React Context または軽量状態管理
{
  user: {
    id: string | null,
    username: string | null,
    isAuthenticated: boolean
  },
  alarms: {
    list: Alarm[],
    loading: boolean,
    error: string | null
  },
  notifications: {
    permission: 'granted' | 'denied' | 'default',
    subscription: PushSubscription | null
  }
}
```

### 4.3 通知機能設計

#### 4.3.1 ブラウザ通知フロー
1. ユーザーに通知許可を要求
2. Push API でサブスクリプション作成
3. サーバーに登録
4. アラーム時刻に通知送信

#### 4.3.2 通知実装例
```javascript
// プッシュ通知登録
async function subscribeToPush() {
  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY'
  });
  
  // サーバーに送信
  await fetch('/api/notifications/subscribe', {
    method: 'POST',
    body: JSON.stringify(subscription),
    headers: { 'Content-Type': 'application/json' }
  });
}

// ポップアップ通知
function showPopupNotification(alarm) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(alarm.title, {
      body: `設定時刻 ${alarm.hour}:${alarm.minute} になりました`,
      icon: '/alarm-icon.png'
    });
  }
}
```

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **レスポンス時間**: API応答時間 < 300ms
- **同時接続数**: 100ユーザー同時接続対応
- **通知遅延**: 設定時刻から5秒以内の通知

### 5.2 セキュリティ要件
- **通信暗号化**: SSL/TLS必須
- **認証**: JWT トークンベース認証
- **パスワード**: bcryptによるハッシュ化
- **XSS対策**: CSP (Content Security Policy) 設定

### 5.3 可用性要件
- **稼働率**: 99.5%以上
- **データバックアップ**: Cloud SQL 自動バックアップ
- **障害復旧**: RTO < 2時間、RPO < 30分

## 6. 技術スタック（GCP基盤）

### 6.1 フロントエンド
- **フレームワーク**: React 18 + TypeScript
- **状態管理**: React Context API
- **UI フレームワーク**: Tailwind CSS
- **通知処理**: Web Push API + Service Worker
- **ビルドツール**: Vite

### 6.2 バックエンド
- **フレームワーク**: FastAPI (Python 3.11+)
- **ORM**: SQLAlchemy
- **認証**: JWT + bcrypt
- **タスクスケジューラー**: Cloud Scheduler
- **プッシュ通知**: py-vapid

### 6.3 GCPサービス
- **ホスティング**: Cloud Run
- **データベース**: Cloud SQL (PostgreSQL)
- **ストレージ**: Cloud Storage (静的アセット)
- **スケジューリング**: Cloud Scheduler
- **監視**: Cloud Monitoring

## 7. GCP環境構築設計

### 7.1 アーキテクチャ図（GCP）
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cloud Storage  │    │   Cloud Run     │    │   Cloud SQL     │
│   (Static Files) │    │   (FastAPI)     │    │  (PostgreSQL)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Cloud CDN       │    │ Cloud Scheduler │    │ Cloud Monitoring│
│ (配信高速化)     │    │  (定期実行)     │    │   (監視・ログ)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 7.2 開発環境セットアップ
```bash
# GCP CLI設定
gcloud auth login
gcloud config set project YOUR_PROJECT_ID

# Cloud SQL インスタンス作成
gcloud sql instances create alarm-db \
  --database-version=POSTGRES_14 \
  --cpu=1 \
  --memory=3.75GB \
  --region=asia-northeast1

# データベース作成
gcloud sql databases create alarmdb --instance=alarm-db

# Cloud Run デプロイ
gcloud run deploy alarm-service \
  --source . \
  --region asia-northeast1 \
  --allow-unauthenticated
```

### 7.3 環境変数設定
```bash
# Cloud Run環境変数
DATABASE_URL=postgresql://user:pass@/alarmdb?host=/cloudsql/project:region:instance
JWT_SECRET_KEY=your-secret-key
VAPID_PUBLIC_KEY=your-vapid-public-key
VAPID_PRIVATE_KEY=your-vapid-private-key
```

## 8. 実装手順

### 8.1 Phase 1 (基盤構築)
1. **GCP環境構築**
   - Cloud SQL インスタンス作成
   - Cloud Run サービス設定
   - IAM権限設定

2. **バックエンド基盤**
   - FastAPI プロジェクト作成
   - データベース接続設定
   - 基本的なCRUD API実装

3. **フロントエンド基盤**
   - React プロジェクト作成
   - 認証機能実装
   - アラーム一覧画面

### 8.2 Phase 2 (機能実装)
1. **アラーム機能**
   - アラーム設定フォーム
   - 一覧表示・編集・削除
   - バリデーション

2. **通知機能**
   - プッシュ通知登録
   - Service Worker実装
   - ポップアップ通知

### 8.3 Phase 3 (最適化)
1. **パフォーマンス最適化**
   - Cloud CDN設定
   - データベースインデックス
   - キャッシュ戦略

2. **運用設定**
   - Cloud Monitoring設定
   - ログ収集
   - アラート設定

## 9. 運用・保守

### 9.1 監視項目
- **アプリケーション**: レスポンス時間、エラー率
- **データベース**: 接続数、クエリ実行時間
- **通知**: 送信成功率、配信遅延

### 9.2 バックアップ戦略
- **データベース**: Cloud SQL自動バックアップ（日次）
- **アプリケーション**: Cloud Source Repositoriesでコード管理
- **設定**: Terraform による Infrastructure as Code

### 9.3 スケーリング計画
- **水平スケーリング**: Cloud Run 自動スケーリング
- **データベース**: Cloud SQL 読み取りレプリカ
- **CDN**: Cloud CDN によるグローバル配信

---

**作成日**: 2025-01-11  
**バージョン**: 1.0  
**対象**: 簡易版Webアラームサービス（音声なし）  
**プラットフォーム**: Google Cloud Platform