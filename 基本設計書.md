# Webアラームサービス 基本設計書

## 1. システム概要

### 1.1 サービス概要
ユーザーが自由に複数のアラームを設定でき、設定時刻に応じて音声によるアナウンスやカウントダウンを提供するWebサービス。

### 1.2 主要機能
- 複数アラームの設定・管理
- 音声によるカウントダウン機能
- リアルタイム通知システム
- レスポンシブWebUI

### 1.3 システムアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │    │   バックエンド    │    │  データベース    │
│   (React/Vue.js)  │◄──►│   (FastAPI)     │◄──►│  (PostgreSQL)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │
         │                        │
         ▼                        ▼
┌─────────────────┐    ┌─────────────────┐
│   Web Audio API  │    │   音声生成API    │
│   (音声再生)      │    │ (AWS Polly/GCP)  │
└─────────────────┘    └─────────────────┘
```

## 2. データ設計

### 2.1 データベース構造

#### 2.1.1 usersテーブル
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.2 alarmsテーブル
```sql
CREATE TABLE alarms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(100) NOT NULL,
    year INTEGER NULL,
    month INTEGER NULL,
    day_of_week INTEGER[] NULL, -- 0=日曜日, 1=月曜日, ...
    hour INTEGER NOT NULL CHECK (hour >= 0 AND hour <= 23),
    minute INTEGER NOT NULL CHECK (minute >= 0 AND minute <= 59),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.3 alarm_logsテーブル
```sql
CREATE TABLE alarm_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    alarm_id UUID REFERENCES alarms(id) ON DELETE CASCADE,
    triggered_at TIMESTAMP NOT NULL,
    status VARCHAR(20) NOT NULL -- 'success', 'missed', 'disabled'
);
```

### 2.2 データフロー
1. ユーザーがアラームを設定
2. バックエンドがアラームデータをDBに保存
3. スケジューラーが定期的にアラームをチェック
4. 発動時刻に応じてフロントエンドに通知
5. フロントエンドが音声再生を実行

## 3. API設計

### 3.1 認証API
- `POST /api/auth/register` - ユーザー登録
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - ユーザー情報取得

### 3.2 アラーム管理API
- `GET /api/alarms` - アラーム一覧取得
- `POST /api/alarms` - アラーム作成
- `PUT /api/alarms/{id}` - アラーム更新
- `DELETE /api/alarms/{id}` - アラーム削除
- `PATCH /api/alarms/{id}/toggle` - アラーム有効/無効切り替え

### 3.3 リアルタイム通知API
- `WebSocket /ws/notifications` - リアルタイム通知

### 3.4 APIレスポンス例

#### アラーム取得レスポンス
```json
{
  "alarms": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "title": "朝のアラーム",
      "year": null,
      "month": null,
      "day_of_week": [1, 2, 3, 4, 5],
      "hour": 7,
      "minute": 30,
      "is_active": true,
      "created_at": "2023-01-01T00:00:00Z",
      "updated_at": "2023-01-01T00:00:00Z"
    }
  ]
}
```

## 4. フロントエンド設計

### 4.1 画面構成
- **ログイン画面** - 認証
- **アラーム一覧画面** - 設定済みアラームの表示・管理
- **アラーム設定画面** - 新規作成・編集
- **通知画面** - カウントダウン表示

### 4.2 コンポーネント設計

#### 4.2.1 主要コンポーネント
- `AlarmList` - アラーム一覧表示
- `AlarmForm` - アラーム設定フォーム
- `CountdownTimer` - カウントダウン表示
- `NotificationPopup` - 通知ポップアップ

#### 4.2.2 状態管理
```javascript
// Redux/Vuex状態設計
{
  auth: {
    user: null | User,
    isAuthenticated: boolean,
    loading: boolean
  },
  alarms: {
    list: Alarm[],
    loading: boolean,
    error: string | null
  },
  notifications: {
    activeCountdowns: Countdown[],
    audioEnabled: boolean
  }
}
```

### 4.3 音声機能設計

#### 4.3.1 音声再生フロー
1. カウントダウンタイミングで音声テキストを生成
2. 音声合成API（AWS Polly等）で音声データを取得
3. Web Audio APIで音声を再生
4. 音量・再生速度の調整機能

#### 4.3.2 音声メッセージ仕様
- 1時間前: "アラームまであと1時間です"
- 10分前〜1分前: "アラームまであと{分}分です"
- 30秒前: "アラームまであと30秒です"
- 10秒前〜1秒前: "10、9、8..."
- 時間到達: "設定時刻になりました"

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **レスポンス時間**: API応答時間 < 200ms
- **同時接続数**: 1000ユーザー同時接続対応
- **音声遅延**: カウントダウン音声の遅延 < 100ms

### 5.2 セキュリティ要件
- **通信暗号化**: SSL/TLS必須
- **認証**: JWT トークンベース認証
- **パスワード**: bcryptによるハッシュ化
- **CSRF対策**: CSRFトークンの実装

### 5.3 可用性要件
- **稼働率**: 99.9%以上
- **データバックアップ**: 日次自動バックアップ
- **障害復旧**: RTO < 1時間、RPO < 15分

## 6. 技術スタック詳細

### 6.1 フロントエンド
- **フレームワーク**: React 18 + TypeScript
- **状態管理**: Redux Toolkit
- **UI フレームワーク**: Material-UI または Tailwind CSS
- **音声処理**: Web Audio API
- **通信**: Axios + WebSocket

### 6.2 バックエンド
- **フレームワーク**: FastAPI (Python 3.11+)
- **ORM**: SQLAlchemy
- **認証**: JWT + bcrypt
- **WebSocket**: FastAPI WebSocket
- **タスクスケジューラー**: Celery + Redis

### 6.3 インフラ
- **データベース**: PostgreSQL 14+
- **キャッシュ**: Redis
- **クラウド**: AWS (EC2, RDS, S3)
- **音声合成**: AWS Polly
- **CI/CD**: GitHub Actions

## 7. 開発・デプロイメント設計

### 7.1 開発環境構築
```bash
# バックエンド
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# フロントエンド
cd frontend
npm install
npm start
```

### 7.2 CI/CD パイプライン
1. **テスト実行**: Unit Test + Integration Test
2. **コード品質チェック**: ESLint, Prettier, Black
3. **ビルド**: Docker イメージ作成
4. **デプロイ**: AWS ECS への自動デプロイ

### 7.3 インフラ構成
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
  
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/alarmdb
  
  db:
    image: postgres:14
    environment:
      - POSTGRES_DB=alarmdb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
  
  redis:
    image: redis:7-alpine
```

## 8. 実装優先度

### Phase 1 (MVP)
- [x] 基本設計書作成
- [ ] ユーザー認証機能
- [ ] アラーム CRUD 機能
- [ ] 基本的な音声通知

### Phase 2 (拡張機能)
- [ ] 詳細なカウントダウン機能
- [ ] レスポンシブUI
- [ ] 音声カスタマイズ

### Phase 3 (運用最適化)
- [ ] パフォーマンス最適化
- [ ] 監視・ログ機能
- [ ] スケーラビリティ改善

---

**作成日**: 2025-01-11  
**バージョン**: 1.0  
**最終更新**: 2025-01-11